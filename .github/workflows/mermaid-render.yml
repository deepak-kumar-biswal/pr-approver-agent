name: Render Mermaid Diagrams

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install mermaid-cli
        run: |
          npm install -g @mermaid-js/mermaid-cli

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Extract Mermaid blocks
        run: |
          python tools/extract_mermaid.py docs/FLOW.md build/mermaid

      - name: Render to SVG/PNG
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          mkdir -p build/mermaid/out
          for f in build/mermaid/*.mmd; do
            base=$(basename "$f" .mmd)
            mmdc -i "$f" -o "build/mermaid/out/${base}.svg" -b transparent
            mmdc -i "$f" -o "build/mermaid/out/${base}.png" -b transparent
          done
          ls -l build/mermaid/out

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mermaid-diagrams
          path: |
            build/mermaid/out/*.svg
            build/mermaid/out/*.png
          if-no-files-found: error
